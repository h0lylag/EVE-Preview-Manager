# Window Focus Handling for Hotkey Cycling

## Overview

This document describes how EVE Preview Manager handles window focus during hotkey cycling, specifically when the "Minimize EVE clients on switch" option is enabled. The implementation follows X11 protocol specifications to ensure reliable focus transfer across different window managers, particularly KWin.

## Problem Statement

When both "minimize EVE clients" and "hide previews when EVE loses focus" options are enabled, hotkey cycling encountered focus issues:

1. **Minimized windows not receiving focus**: Calling `activate_window` on a minimized window would raise it to front but not grant keyboard input focus
2. **Background window interference**: KWin would redirect focus to background X11 windows during the window minimize operations
3. **Immediate FocusOut events**: Windows would briefly gain focus, then immediately lose it, causing preview thumbnails to hide

## X11 Protocol Requirements

### SetInputFocus Specification

According to the [X11 Protocol Specification](https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html):

> This request changes the input focus and the last-focus-change time. The request has no effect if the specified time is earlier than the current last-focus-change time or is later than the current server time.

Key requirements:
- **Window must be viewable**: "The specified focus window must be viewable at the time of the request (or a Match error results)"
- **Timestamp required**: Must use event timestamp, not `CurrentTime` (per ICCCM)
- **Revert behavior**: When window becomes unviewable, focus behavior depends on `revert-to` parameter

### ICCCM Conventions

The [Inter-Client Communication Conventions Manual](https://tronche.com/gui/x/icccm/sec-4.html) specifies:

> Clients that use a SetInputFocus request must set the time argument to the timestamp of the event that caused them to make the attempt. This cannot be a FocusIn event because they do not have timestamps. Clients must not use CurrentTime for the time argument.

> Clients that use a SetInputFocus request to set the focus to one of their windows must set the revert-to field to Parent.

## Implementation

### Window Activation Sequence

When a hotkey is pressed to cycle to a window (when minimize mode is enabled), the following sequence occurs:

```rust
// 1. Unminimize target window (if minimize mode enabled)
if resources.config.profile.client_minimize_on_switch {
    unminimize_window(conn, screen, atoms, window)?;
}

// 2. Activate window with explicit focus transfer
activate_window(conn, screen, atoms, window, timestamp)?;

// 3. Delay to let focus settle (if minimize mode enabled)
if resources.config.profile.client_minimize_on_switch {
    tokio::time::sleep(Duration::from_millis(25)).await;
}

// 4. Minimize other EVE clients
for other_window in other_windows {
    minimize_window(conn, screen, atoms, other_window)?;
}
```

### Step 1: Unminimize Window

**Purpose**: Ensures the window is "viewable" as required by the X11 spec before calling `SetInputFocus`.

**Implementation** ([`src/x11/ops.rs`](file:///home/chris/scripts/EVE-Preview-Manager/src/x11/ops.rs)):

```rust
pub fn unminimize_window(
    conn: &RustConnection,
    screen: &Screen,
    atoms: &CachedAtoms,
    window: Window,
) -> Result<()> {
    // Remove _NET_WM_STATE_HIDDEN flag
    let event = ClientMessageEvent {
        type_: atoms.net_wm_state,
        data: ClientMessageData::from([
            NET_WM_STATE_REMOVE,  // Action: 0 = remove
            atoms.net_wm_state_hidden,
            0,
            ACTIVE_WINDOW_SOURCE_PAGER,
            0,
        ]),
        // ... other fields
    };
    
    conn.send_event(/* ... */)
}
```

This removes the `_NET_WM_STATE_HIDDEN` atom and sends a `WM_CHANGE_STATE` message with `NORMAL_STATE` (value: 1) to restore the window.

### Step 2: Activate Window with SetInputFocus

**Purpose**: Explicitly transfers keyboard input focus to the target window.

**Implementation** ([`src/x11/ops.rs`](file:///home/chris/scripts/EVE-Preview-Manager/src/x11/ops.rs)):

```rust
pub fn activate_window(
    conn: &RustConnection,
    screen: &Screen,
    atoms: &CachedAtoms,
    window: Window,
    timestamp: u32,  // From hotkey event (NOT CurrentTime)
) -> Result<()> {
    // Raise window to top
    conn.configure_window(
        window,
        &ConfigureWindowAux::new().stack_mode(StackMode::ABOVE),
    )?;

    // Request WM activation via EWMH
    let event = ClientMessageEvent {
        type_: atoms.net_active_window,
        data: ClientMessageData::from([
            ACTIVE_WINDOW_SOURCE_PAGER,  // Source: 2 = direct user action
            timestamp,
            0, 0, 0
        ]),
        // ... other fields
    };
    conn.send_event(/* ... */)?;

    // Explicitly set input focus (ICCCM compliant)
    conn.set_input_focus(
        InputFocus::PARENT,  // RevertToParent per ICCCM
        window,
        timestamp
    )?;

    conn.flush()?;
    Ok(())
}
```

**Why both `_NET_ACTIVE_WINDOW` and `SetInputFocus`?**

- `_NET_ACTIVE_WINDOW`: Polite EWMH request to the window manager
- `SetInputFocus`: Direct X11 call that forcefully transfers keyboard input

KWin's focus stealing prevention sometimes ignores `_NET_ACTIVE_WINDOW` alone during complex window state transitions. Adding `SetInputFocus` ensures focus transfer completes.

### Step 3: Focus Settle Delay (25ms)

**Purpose**: Allows the window manager to complete the focus transfer before we start minimizing other windows.

**Rationale**: Without this delay, minimizing other windows immediately after activation can cause KWin to redirect focus to background windows. The 25ms window allows:
- WM to process the focus change
- X11 server to generate and deliver `FocusIn` events
- Window state to stabilize

This is not an X11 spec requirement but a practical workaround for KWin's focus management timing.

### Step 4: Minimize Other Windows

Once focus has settled on the target window, other EVE clients are minimized by setting `_NET_WM_STATE_HIDDEN` and sending `WM_CHANGE_STATE` with `ICONIC_STATE` (value: 3).

## Allowed Windows Tracking

To support the "hotkeys require EVE focus" feature, we track which windows should be allowed to process hotkeys:

```rust
let mut current_windows: HashSet<u32> = HashSet::new();

for (src_window, thumbnail) in resources.eve_clients.iter() {
    current_windows.insert(*src_window);      // EVE client window
    current_windows.insert(thumbnail.window()); // Thumbnail overlay window
}
```

This ensures hotkeys work when focus is on either:
- The EVE client windows themselves
- Their corresponding thumbnail overlays (during hide/show transitions)

## Constants Used

From [`src/common/constants.rs`](file:///home/chris/scripts/EVE-Preview-Manager/src/common/constants.rs):

```rust
pub mod x11 {
    /// Source indication for _NET_ACTIVE_WINDOW (2 = pager/direct user action)
    pub const ACTIVE_WINDOW_SOURCE_PAGER: u32 = 2;
    
    /// _NET_WM_STATE action: add/set property (1)
    pub const NET_WM_STATE_ADD: u32 = 1;
    
    /// _NET_WM_STATE action: remove property (0)
    pub const NET_WM_STATE_REMOVE: u32 = 0;
    
    /// WM_CHANGE_STATE normal value (requests the WM to restore/deiconify)
    pub const NORMAL_STATE: u32 = 1;
    
    /// WM_CHANGE_STATE iconic value (requests the WM to minimize)
    pub const ICONIC_STATE: u32 = 3;
}
```

## References

### X11 Protocol Specification
- [SetInputFocus](https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html) - Core X11 protocol documentation
- [FocusIn/FocusOut Events](https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html#events:FocusIn) - Event documentation

### ICCCM (Inter-Client Communication Conventions Manual)
- [Input Focus](https://tronche.com/gui/x/icccm/sec-4.html#s-4.1.7) - Focus conventions
- [Client Responses to WM Actions](https://tronche.com/gui/x/icccm/sec-4.html#s-4.2.7) - WM_TAKE_FOCUS protocol

### EWMH (Extended Window Manager Hints)
- `_NET_ACTIVE_WINDOW` - Request window activation
- `_NET_WM_STATE` - Window state management
- `_NET_WM_STATE_HIDDEN` - Minimized/iconified state

## Verification

The implementation can be verified through debug logging:

```
SetInputFocus completed successfully window=253755393
activate_window completed successfully window=253755393
FocusIn received window=253755393
```

Successful operation shows:
1. `SetInputFocus completed successfully` - X11 call succeeded
2. `activate_window completed successfully` - Full activation sequence completed
3. `FocusIn received` - X11 server confirmed focus transfer
4. No immediate `FocusOut` events (focus is stable)

## Related Files

- [`src/x11/ops.rs`](file:///home/chris/scripts/EVE-Preview-Manager/src/x11/ops.rs) - X11 window operations
- [`src/daemon/main_loop.rs`](file:///home/chris/scripts/EVE-Preview-Manager/src/daemon/main_loop.rs#L533-L570) - Hotkey activation sequence
- [`src/common/constants.rs`](file:///home/chris/scripts/EVE-Preview-Manager/src/common/constants.rs#L17-L28) - X11 protocol constants
